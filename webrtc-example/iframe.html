<!DOCTYPE html>
<html lang="en">
    <head>
      <meta charset="utf-8">
      <title>iframe</title>
      <script src="https://www.research.dev.cc/wp-includes/js/jquery/jquery.js"></script>
      <script src="iframe-messaging.js?"></script>
      <link rel="stylesheet" href="main.css" type="text/css" media="all">
      <script src="adapter.js"></script>
      <script>
        (function($) {
          $(function() {
              var remoteConnection = null;
              var receiveChannel = null;
              im.onReceiveMessage(function(message) {
                  console.log("in iFrame: received message: ");
                  console.log(message);
                  if (message.localDescription) {
                    console.log("localDescription received!");
                    remoteConnection = new RTCPeerConnection();
                    remoteConnection.ondatachannel = function(event) {
                      receiveChannel = event.channel;
                      receiveChannel.onmessage = function(event) {
                        var el = document.createElement("p");
                        var txtNode = document.createTextNode(event.data);
                        el.appendChild(txtNode);
                        let receiveBox = document.getElementById('receivebox');
                        receiveBox.appendChild(el);
                      };
                      receiveChannel.onopen = function() {
                        console.log("sendChannel.readyState is " + receiveChannel.readyState);
                      };
                      receiveChannel.onclose = function() {
                        console.log("sendChannel.readyState is " + receiveChannel.readyState);
                      };
                    };
                    remoteConnection.setRemoteDescription(message.localDescription).then(function() {
                      remoteConnection.createAnswer().then(function(answer) {
                        console.log("Got answer in iframe remoteConnection.createAnswer");
                        remoteConnection.setLocalDescription(answer).then(function() {
                          im.sendMessage({
                            localDescription: remoteConnection.localDescription.toJSON()
                          });
                        });
                      });
                    });
                  }
                  if (message.candidate) {
                    remoteConnection.onicecandidate = function(e) {
                        if (e.candidate) {
                          im.sendMessage({candidate: e.candidate.toJSON()});
                        }
                    };
                    remoteConnection.addIceCandidate(message.candidate).catch(function(e) {
                      console.log("remoteConnection error: " + JSON.stringify(e.toJSON()));
                    });
                  }
                  if (message.disconnect) {
                    receiveChannel.close();
                    remoteConnection.close();
                    receiveChannel = null;
                    remoteConnection = null;
                  }   
              });
          });
        })(jQuery);
      </script>
    </head>
    <body>
        This is the iframe.<br/>
        <h1>MDN - WebRTC: Simple RTCDataChannel sample</h1>
        <div class="messagebox" id="receivebox">
          <p>Messages received:</p>
        </div>
    </body>
</html>