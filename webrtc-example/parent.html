<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Parent</title>
        <script src="https://webxrpress.org/wp-includes/js/jquery/jquery.min.js"></script>
        <script src="iframe-messaging.js?"></script>
        <link rel="stylesheet" href="main.css" type="text/css" media="all">
        <script src="adapter.js"></script>

        <script>
        (function($) {
          $(function() {
            var localConnection = null;   // RTCPeerConnection for our "local" connection
            var sendChannel = null;
            $("#connectButton").click(function() {
              localConnection = new RTCPeerConnection();
              sendChannel = localConnection.createDataChannel("sendChannel");
              sendChannel.onopen = function() {
                console.log("sendChannel.readyState is " + sendChannel.readyState);
              };
              sendChannel.onclose = function() {
                console.log("sendChannel.readyState is " + sendChannel.readyState);
              };
              localConnection.onicecandidate = function(e) {
                if (e.candidate) {
                  im.sendMessage({candidate: e.candidate.toJSON()});
                }
              };
              localConnection.createOffer().then(function(offer) {
                return localConnection.setLocalDescription(offer);
              }).then(function() {
                im.sendMessage({
                  localDescription: localConnection.localDescription.toJSON()
                });
              }).catch(function(e) {
                console.log("localConnection error: " + JSON.stringify(e.toJSON()));
              });
            });
            $("#sendButton").click(function() {
                sendChannel.send($('#message').val());
                $('#message').val('');
            });
            $("#disconnectButton").click(function() {
              sendChannel.close();
              localConnection.close();
              sendChannel = null;
              localConnection = null;
              im.sendMessage({
                disconnect: true
              });
            });
            im.onReceiveMessage(function(message) {
              if (message.localDescription) {
                localConnection.setRemoteDescription(message.localDescription);
              }
              if (message.candidate) {
                localConnection.addIceCandidate(message.candidate).catch(function(e) {
                  console.log("im.ReceiveMessage error: " + JSON.stringify(e.toJSON()));
                });
              }
            });
          });
        })(jQuery);
        </script>
    </head>
    <body>
        This is the parent.<br/>
        <iframe id="theIFrame" src="./iframe.html?1254" width="500px" height="320px"></iframe>

        <h1>MDN - WebRTC: Simple RTCDataChannel sample</h1>
        
        <div class="controlbox">
          <button id="connectButton" name="connectButton" class="buttonleft">
            Connect
          </button>
          <button id="disconnectButton" name="disconnectButton" class="buttonright">
            Disconnect
          </button>
        </div>
        
        <div class="messagebox">
          <label for="message">Enter a message:
            <input type="text" name="message" id="message" placeholder="Message text" 
                    inputmode="latin" size=60 maxlength=120>
          </label>
          <button id="sendButton" name="sendButton" class="buttonright">
            Send
          </button>
        </div>
        <div class="messagebox" id="receivebox">
          <p>Messages received:</p>
        </div>
    </body>
</html>
